name: Reusable LLM Code Review
on:
  workflow_call:
    inputs:
      base_branch: { type: string, default: "main" }
      model:       { type: string, default: "o4-mini" }
    secrets:
      OPENAI_API_KEY: { required: true }

permissions:
  contents: read
  pull-requests: write
  checks: write

jobs:
  review:
    runs-on: ubuntu-latest
    steps:
      # ① 호출한(대상) 리포 체크아웃 — diff 계산용
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }

      # ② 중앙 리포(스크립트 있는 곳) 체크아웃 — 실행용
      - name: Checkout tool repo (central)
        uses: actions/checkout@v4
        with:
          repository: seoha8952/llm-code-review   # ← 중앙 리포 '명시'
          ref: v1                                    # ← 태그로 고정(권장)
          path: _llm                                 # 서브폴더

      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }

      - name: Install ctags
        run: |
          sudo apt-get update
          if ! sudo apt-get install -y universal-ctags; then
            sudo apt-get install -y ctags || sudo apt-get install -y exuberant-ctags
          fi
          ctags --version

      - run: pip install requests

      - name: Run review
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          BASE_BRANCH: ${{ inputs.base_branch }}
          OPENAI_MODEL: ${{ inputs.model }}
        run: python _llm/scripts/run_review.py      # ← 중앙 리포 경로에서 실행
